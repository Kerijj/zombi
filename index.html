<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–π—Å 245: –ñ–µ–ª–µ–∑–Ω–æ–µ –°–µ—Ä–¥—Ü–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #c9d1d9; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
        }
        /* –ù–µ–æ–Ω–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è UI */
        .text-neon {
            color: #00ffc4;
            text-shadow: 0 0 5px #00ffc4, 0 0 10px #00ffc4;
        }
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ */
        .btn-primary {
            transition: all 0.1s ease;
            background-color: #00ffc4;
            color: #161b22;
            font-weight: bold;
            box-shadow: 0 4px #00a683;
            border-radius: 0.5rem; /* –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
        }
        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 2px #00a683;
            transform: translateY(2px);
        }
        .btn-primary:disabled {
            box-shadow: none;
            cursor: not-allowed;
            background-color: #374151;
            color: #9ca3af;
            opacity: 0.6;
            transform: translateY(0);
        }
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ */
        #log-area::-webkit-scrollbar {
            width: 6px;
        }
        #log-area::-webkit-scrollbar-thumb {
            background-color: #00ffc450;
            border-radius: 3px;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –≤ –∑–∞–¥–∞–Ω–∏–∏ */
        .timer-red {
            color: #ff4d4d;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="game-container" class="max-w-4xl mx-auto bg-[#161b22] border border-gray-700 rounded-xl shadow-2xl">
        
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="stats-bar" class="flex justify-between p-4 border-b border-gray-700 text-sm md:text-base font-semibold">
            <div id="lives-display" class="flex items-center text-red-400">‚ù§Ô∏è –ñ–∏–∑–Ω–∏: 3</div>
            <div id="chips-display" class="flex items-center text-yellow-400">üåü –ß–∏–ø—ã: 0</div>
            <div id="moral-display" class="flex items-center text-indigo-400">‚öñÔ∏è –ú–æ—Ä–∞–ª—å: 10</div>
            <div id="time-display" class="flex items-center text-neon">‚è±Ô∏è –í—Ä–µ–º—è: 02:00:00</div>
        </div>

        <div class="md:flex">
            <!-- –ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π -->
            <div class="md:w-3/5 p-6 md:p-8 border-b md:border-b-0 md:border-r border-gray-700">
                <h2 class="text-2xl font-extrabold mb-4 text-neon">
                    <span id="step-key"></span>
                </h2>
                <div id="step-text" class="text-lg leading-relaxed mb-6">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                </div>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ -->
                <div id="choices-container" class="space-y-4">
                    <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã JavaScript'–æ–º -->
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–≤–æ–¥–∞ –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫ -->
                <div id="puzzle-input-container" class="mt-6 hidden">
                    <p id="puzzle-hint" class="text-sm text-gray-400 mb-2"></p>
                    <div class="flex space-x-2">
                        <input type="text" id="puzzle-input" class="flex-grow p-3 rounded-lg bg-[#0d1117] border border-gray-600 focus:ring-neon focus:border-neon text-white" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
                        <button id="puzzle-button" class="btn-primary py-3 px-6 rounded-lg whitespace-nowrap">–û–¢–í–ï–¢</button>
                    </div>
                    <p id="puzzle-message" class="mt-2 text-sm font-semibold"></p>
                </div>
            </div>

            <!-- –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π / –ò—Å—Ç–æ—Ä–∏—è (–≤–ø–∏—Å–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è) -->
            <div class="md:w-2/5 p-6 md:p-8">
                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-neon">–ñ—É—Ä–Ω–∞–ª –†–µ–π—Å–∞ 245</h3>
                <div id="log-area" class="h-96 overflow-y-auto space-y-3 text-sm pr-2">
                    <div class="text-gray-500">–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è.</div>
                </div>
            </div>
        </div>
        
        <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="final-screen" class="hidden fixed inset-0 bg-[#161b22]/95 backdrop-blur-sm flex flex-col items-center justify-center p-8 rounded-xl z-10">
            <h1 id="final-title" class="text-5xl font-extrabold mb-4 text-red-500">–ö–û–ù–ï–¶ –ò–ì–†–´</h1>
            <p id="final-text" class="text-xl text-center mb-8"></p>
            <p id="final-stats" class="text-lg font-mono"></p>
            <button onclick="location.reload()" class="mt-8 btn-primary font-bold py-3 px-6 rounded-lg">–ù–ê–ß–ê–¢–¨ –°–ù–û–í–ê</button>
        </div>

    </div>

    <script>
        // =========================================================================
        // –õ–û–ì–ò–ö–ê –ò–ì–†–´ (QUEST.JS)
        // =========================================================================

        // --- 1. –°—Ç—Ä—É–∫—Ç—É—Ä—ã –î–∞–Ω–Ω—ã—Ö –∏ –°—Ü–µ–Ω–∞—Ä–∏–π ---

        /** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞. */
        const Effect = (lives, bonuses, moral, time) => ({ lives, bonuses, moral, time });

        /** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞. */
        const Choice = (text, next, requiredBonus = 0, effect) => ({ text, next, requiredBonus, effect });

        /** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω —à–∞–≥ –≤ –∫–≤–µ—Å—Ç–µ. */
        const Step = (key, text, type, config = {}) => ({
            key, 
            text, 
            type,
            correctAnswer: config.correctAnswer || null,
            correctAnswerText: config.correctAnswerText || null,
            correctAnswerBool: config.correctAnswerBool || false,
            successNext: config.successNext || null,
            failureNext: config.failureNext || null, // –î–ª—è –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –≤—Ä–µ–º—è
            choices: config.choices || null,
            timeLimit: config.timeLimit || 0 // –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –Ω–∞ –æ—Ç–≤–µ—Ç –≤ –¥–∞–Ω–Ω–æ–º —à–∞–≥–µ (–¥–ª—è speed_quiz)
        });

        const SECONDS_IN_HOUR = 3600;
        const INITIAL_TIME_LIMIT_SECONDS = 2 * SECONDS_IN_HOUR; // 2 —á–∞—Å–∞

        // –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–≤–µ—Å—Ç–∞ (QUEST_STEPS)
        const QUEST_STEPS = {
            // === –°–¢–ê–†–¢ –ò –í–´–ë–û–† –í–ï–¢–ö–ò ===
            "start": Step("start", 
                "–¢—ã –ø—Ä–∏—Ö–æ–¥–∏—à—å –≤ —Å–µ–±—è –≤ –ø–æ–ª—É—Ä–∞–∑—Ä—É—à–µ–Ω–Ω–æ–º –∞–Ω–≥–∞—Ä–µ. –ò–º–ø–ª–∞–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –Ω–æ —Å–∏–≥–Ω–∞–ª —Å–ª–∞–±—ã–π. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ë—É–Ω–∫–µ—Ä \"–ê–≤—Ä–æ—Ä–∞\".\n" +
                "2047 –≥–æ–¥. –ú–∏—Ä –ø–∞–ª –∂–µ—Ä—Ç–≤–æ–π \"–ö—Ä–∞—Å–Ω–æ–π —á—É–º—ã\". –í—ã ‚Äî –†–µ–π—Å 245, –æ–¥–∏–Ω –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏—Ö, –æ–±–ª–∞–¥–∞—é—â–∏—Ö –∏–º–º—É–Ω–∏—Ç–µ—Ç–æ–º –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –∫–∏–±–µ—Ä–Ω–µ—Ç–∏—á–µ—Å–∫–∏–º –∏–º–ø–ª–∞–Ω—Ç–æ–º.\n" +
                "–í—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø—É—Ç—å:", "start_scenario", 
                {
                    choices: [
                        Choice("‚û°Ô∏è –í–µ—Ç–∫–∞ –ê: –ß–µ—Ä–µ–∑ –ó–∞–±—Ä–æ—à–µ–Ω–Ω—É—é –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é '–ì–µ–Ω–µ–∑–∏—Å'", "lab_start_scenario"),
                        Choice("‚¨ÖÔ∏è –í–µ—Ç–∫–∞ –í: –ß–µ—Ä–µ–∑ –ü–æ–¥–∑–µ–º–Ω—ã–π –ü–∞—Ä–∫–∏–Ω–≥ '–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä'", "parking_start_scenario")
                    ]
                }
            ),

            // =========================================================================
            // ‚öôÔ∏è –í–ï–¢–ö–ê –ê: –õ–ê–ë–û–†–ê–¢–û–†–ò–Ø
            // =========================================================================
            "lab_start_scenario": Step("lab_start_scenario",
                "–õ–ê–ë–û–†–ê–¢–û–†–ò–Ø \"–ì–ï–ù–ï–ó–ò–°\". –í –≤–æ–∑–¥—É—Ö–µ –≤–∏—Ç–∞–µ—Ç –µ–¥–∫–∏–π –∑–∞–ø–∞—Ö —Ñ–æ—Ä–º–∞–ª–∏–Ω–∞ –∏ —Å—Ç—Ä–∞—Ö–∞. –†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –∫–æ–ª–±—ã –∏ —Å–ª–æ–º–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—é—Ç –æ—â—É—â–µ–Ω–∏–µ –Ω–µ–¥–∞–≤–Ω–µ–π –ø–∞–Ω–∏–∫–∏. –ó–∞–¥–∞—á–∞: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–µ–∑–∏–Ω—Ñ–µ–∫—Ü–∏—é –∏ –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç—É.",
                "start_scenario",
                {
                    choices: [Choice("–ù–∞—á–∞—Ç—å: –ü–∞–Ω–µ–ª—å 1 (–í–∑–ª–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)", "lab_task_1")]
                }
            ),
            "lab_task_1": Step("lab_task_1", "–ü–∞–Ω–µ–ª—å 1: –ì–æ–ª–æ–≥—Ä–∞–º–º–∞: '–ß—Ç–æ –≤—Å–µ–≥–¥–∞ –±–µ–∂–∏—Ç, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å—Ç–∞–µ—Ç?'",
                "logic_puzzle", { correctAnswer: "—Ä–µ–∫–∞", successNext: "lab_task_2" }),

            "lab_task_2": Step("lab_task_2", "–ü–∞–Ω–µ–ª—å 2: –°–ª—ã—à–µ–Ω –∫—Ä–∏–∫. –°–ø–∞—Å–∞—Ç—å –≤—ã–∂–∏–≤—à–µ–≥–æ (-10 –º–∏–Ω—É—Ç) –∏–ª–∏ –∏—Å–∫–∞—Ç—å —á–∏–ø—ã (+2 –ß–∏–ø–∞)?",
                "decision_scenario",
                {
                    choices: [
                        Choice("ü§ù –°–ø–∞—Å–∞—Ç—å (+2 –ú–æ—Ä–∞–ª—å, -600 —Å–µ–∫)", "lab_task_3", 0, Effect(0, 0, 2, -600)),
                        Choice("üí∞ –ò—Å–∫–∞—Ç—å —á–∏–ø—ã (+2 –ß–∏–ø–∞, -2 –ú–æ—Ä–∞–ª—å)", "lab_task_3", 0, Effect(0, 2, -2, 0))
                    ]
                }),
            "lab_task_3": Step("lab_task_3", "–ü–∞–Ω–µ–ª—å 3: –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ñ–∞–∫—Ç–∞. '–§–∞–∫—Ç: \"–ö—Ä–∞—Å–Ω–∞—è —á—É–º–∞\" –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫—Ä–æ–≤—å.'",
                "believe", { correctAnswerBool: false, successNext: "lab_task_4" }),

            "lab_task_4": Step("lab_task_4", "–ü–∞–Ω–µ–ª—å 4: –ó–ê–ö–õ–ò–ù–ò–õ–û –î–í–ï–†–¨. –£ —Ç–µ–±—è –µ—Å—Ç—å —á–∏–ø-–æ—Ç–º—ã—á–∫–∞, –∏–ª–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –≤–∑–ª–∞–º—ã–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏.",
                "decision_scenario",
                {
                    choices: [
                        Choice("üîë –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ß–∏–ø (-1 –ß–∏–ø, +2 –ú–æ—Ä–∞–ª—å)", "hall_junction", 1, Effect(0, -1, 2, 0)),
                        Choice("üî® –í–∑–ª–æ–º (–®—É–º, -1 –ñ–∏–∑–Ω—å, -1 –ú–æ—Ä–∞–ª—å)", "hall_junction", 0, Effect(-1, 0, -1, 0))
                    ]
                }),

            // =========================================================================
            // üöó –í–ï–¢–ö–ê –í: –ü–ê–†–ö–ò–ù–ì
            // =========================================================================
            "parking_start_scenario": Step("parking_start_scenario",
                "–ü–ê–†–ö–ò–ù–ì \"–ö–ê–¢–ê–õ–ò–ó–ê–¢–û–†\". –í–æ–∑–¥—É—Ö –Ω–∞–ø–æ–ª–Ω–µ–Ω –∑–∞–ø–∞—Ö–æ–º –≤—ã—Ö–ª–æ–ø–Ω—ã—Ö –≥–∞–∑–æ–≤ –∏ –±–µ—Ç–æ–Ω–∞. –ù–∏–∑–∫–∏–π –ø–æ—Ç–æ–ª–æ–∫ –∏ —Ö–∞–æ—Ç–∏—á–Ω—ã–µ —Ç–µ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –æ—â—É—â–µ–Ω–∏–µ –∑–∞–ø–∞–¥–Ω–∏. –ó–∞–¥–∞—á–∞: –ù–∞–π—Ç–∏ —Ç–æ–ø–ª–∏–≤–æ, —á—Ç–æ–±—ã –ø—Ä–æ–±–∏—Ç—å –¥–≤–µ—Ä—å.",
                "start_scenario",
                {
                    choices: [Choice("–ù–∞—á–∞—Ç—å: –ó–æ–Ω–∞ 1 (–†–∞—Å—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∞–ª–∞)", "parking_task_1")]
                }
            ),
            "parking_task_1": Step("parking_task_1", "–ó–æ–Ω–∞ 1: –Ø –≤—Å–µ–≥–¥–∞ –Ω–∞ –ø–æ–ª—É, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–¥–Ω–∏–º–∞—é—Å—å. –ß—Ç–æ —è?",
                "logic_puzzle", { correctAnswer: "—Ç–µ–Ω—å", successNext: "parking_task_2" }),

            "parking_task_2": Step("parking_task_2", "–ó–æ–Ω–∞ 2: –í–∑—è—Ç—å –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Ç–æ–ø–ª–∏–≤–æ (+2 –º–∏–Ω—É—Ç—ã) –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö (+3 –ú–æ—Ä–∞–ª—å)?",
                "decision_scenario",
                {
                    choices: [
                        Choice("üí∞ –í–∑—è—Ç—å —Ç–æ–ø–ª–∏–≤–æ (+120 —Å–µ–∫, -2 –ú–æ—Ä–∞–ª—å)", "parking_task_3", 0, Effect(0, 0, -2, 120)),
                        Choice("ü§ù –û—Å—Ç–∞–≤–∏—Ç—å (+3 –ú–æ—Ä–∞–ª—å)", "parking_task_3", 0, Effect(0, 0, 3, 0))
                    ]
                }),

            "parking_task_3": Step("parking_task_3", "–ó–æ–Ω–∞ 3: –í–µ—Ä–Ω–æ –ª–∏, —á—Ç–æ –∑–∞—Ä–∞–∂–µ–Ω–Ω—ã–µ –±–æ—è—Ç—Å—è –æ–≥–Ω—è?",
                "believe", { correctAnswerBool: true, successNext: "hall_junction" }),

            // =========================================================================
            // üèõÔ∏è –õ–û–ö–ê–¶–ò–Ø 2: –ó–ê–õ –°–û–ï–î–ò–ù–ï–ù–ò–ô (–•–ê–ë)
            // =========================================================================
            "hall_junction": Step("hall_junction",
                "–ó–ê–õ –°–û–ï–î–ò–ù–ï–ù–ò–ô. –¢—ã —Å—Ç–æ–∏—à—å –ø–µ—Ä–µ–¥ –¥–≤—É–º—è –º–∞—Å—Å–∏–≤–Ω—ã–º–∏ –ø—É—Ç—è–º–∏. –í–ø–µ—Ä–µ–¥–∏ ‚Äî –≥–µ—Ä–º–µ—Ç–∏—á–Ω–∞—è —Å—Ç–∞–ª—å–Ω–∞—è –¥–≤–µ—Ä—å, –≤–µ–¥—É—â–∞—è, —Å—É–¥—è –ø–æ –≤—Å–µ–º—É, –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤—Ö–æ–¥—É –≤ –ë–£–ù–ö–ï–†. –í–Ω–∏–∑—É ‚Äî —Ä–∂–∞–≤—ã–π –ª—é–∫, —Å–∫–≤–æ–∑—å –∫–æ—Ç–æ—Ä—ã–π —Ç—è–Ω–µ—Ç —Å—ã—Ä–æ—Å—Ç—å—é –∏ –≥—É–ª–∫–∏–º —ç—Ö–æ–º (–ü–û–î–í–ê–õ–´).",
                "start_scenario",
                {
                    choices: [
                        Choice("‚¨áÔ∏è –í–Ω–∏–∑: –í –ü–æ–¥–≤–∞–ª—ã (–û–ø–∞—Å–Ω–æ, –Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –±—ã—Å—Ç—Ä–µ–µ)", "basement_start"),
                        Choice("‚¨ÜÔ∏è –ü—Ä—è–º–æ: –í—Ö–æ–¥ –≤ –ë—É–Ω–∫–µ—Ä (–†–∏—Å–∫: –°–∏—Å—Ç–µ–º—ã –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)", "bunker_start_scenario")
                    ]
                }
            ),

            // =========================================================================
            // üíÄ –í–ï–¢–ö–ê C: –ü–û–î–í–ê–õ–´ (–°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç)
            // =========================================================================
            "basement_start": Step("basement_start",
                "–ü–û–î–í–ê–õ–´. –í—Å–ø—ã—Ö–∏–≤–∞–µ—Ç –∞–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–Ω–∞—Ä—å, –æ—Å–≤–µ—â–∞—è —Ç—É—Å–∫–ª–æ–µ –º–µ—Å–∏–≤–æ –∏–∑ —Ç—Ä—É–± –∏ –≤–ª–∞–≥–∏. –ò–∑ —Ç–µ–º–Ω–æ—Ç—ã —Ä–∞–∑–¥–∞–ª—Å—è –≥–ª—É—Ö–æ–π, —Ü–∞—Ä–∞–ø–∞—é—â–∏–π –∑–≤—É–∫. –¢—ã –¥–æ–ª–∂–µ–Ω –±—ã—Å—Ç—Ä–æ –≤–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Å–≤–µ—Ç, –ø—Ä–µ–∂–¥–µ —á–µ–º –æ–Ω–∏ —Ç–µ–±—è –Ω–∞–π–¥—É—Ç.",
                "start_scenario",
                {
                    choices: [Choice("–ù–∞–π—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω—ã–π —â–∏—Ç (–ù–∞ –≤—Ä–µ–º—è)", "basement_task_1")]
                }
            ),

            // –°–¢–†–ï–°–°–û–í–û–ï –ó–ê–î–ê–ù–ò–ï –ù–ê –í–†–ï–ú–Ø
            "basement_task_1": Step("basement_task_1", "–®–ò–¢–û–ö! –í–≤–µ–¥–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –±—É–∫–≤—É –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: '–ö, –õ, –ú, –ù, [?], –ü, –†'.",
                "speed_quiz", { correctAnswer: "–æ", successNext: "basement_task_2", failureNext: "basement_failure", timeLimit: 15 }),

            "basement_failure": Step("basement_failure",
                "–¢—ã –∑–∞–º–µ—à–∫–∞–ª—Å—è, –∏ —Ç–µ–Ω—å –º–µ—Ç–Ω—É–ª–∞—Å—å –≤ —É–≥–ª—É! –ß—Ç–æ-—Ç–æ —Ü–∞—Ä–∞–ø–Ω—É–ª–æ –ø–æ –Ω–æ–≥–µ. –¢—ã —Ç–µ—Ä—è–µ—à—å —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—à—å —Ç—Ä–∞–≤–º—É. (-2 –ñ–∏–∑–Ω–∏, -60 —Å–µ–∫)",
                "decision_scenario",
                {
                    choices: [
                        Choice("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å –≤ —Ç–µ–º–Ω–æ—Ç–µ", "basement_task_3", 0, Effect(-2, 0, 0, -60))
                    ]
                }),

            "basement_task_2": Step("basement_task_2",
                "–°–í–ï–¢! –¢—ã —É—Å–ø–µ–ª. –í —Å–≤–µ—Ç–µ –≤–∏–¥–Ω—ã —Å–∏–ª—É—ç—Ç—ã –¥–≤—É—Ö —Å—É—â–µ—Å—Ç–≤, –∑–∞—Å—Ç—ã–≤—à–∏—Ö –≤ —Ç–µ–Ω–∏. –ù–æ —Ç—ã –≤–∏–¥–∏—à—å –∏ –±—Ä–æ—à–µ–Ω–Ω—ã–π —Ä—é–∫–∑–∞–∫ —Å –ø—Ä–∏–ø–∞—Å–∞–º–∏. –í–∑—è—Ç—å?",
                "decision_scenario",
                {
                    choices: [
                        Choice("üí∞ –í–∑—è—Ç—å —Ä—é–∫–∑–∞–∫ (+3 –ß–∏–ø–∞, -1 –ñ–∏–∑–Ω—å)", "basement_task_3", 0, Effect(-1, 3, 0, 0)),
                        Choice("üö∂‚Äç‚ôÇÔ∏è –ü—Ä–æ–π—Ç–∏ –º–∏–º–æ (+2 –ú–æ—Ä–∞–ª—å, -60 —Å–µ–∫)", "basement_task_3", 0, Effect(0, 0, 2, -60))
                    ]
                }),

            "basement_task_3": Step("basement_task_3",
                "–¢—ã –Ω–∞—à–µ–ª –≤—ã—Ö–æ–¥ –∏–∑ –ø–æ–¥–≤–∞–ª–æ–≤ —á–µ—Ä–µ–∑ —Å–ª—É–∂–µ–±–Ω—ã–π –ª–∏—Ñ—Ç. –ü—É—Ç—å –æ—Ç–∫—Ä—ã—Ç –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –∫–æ—Ä–∏–¥–æ—Ä—É –ë—É–Ω–∫–µ—Ä–∞.",
                "start_scenario",
                {
                    choices: [Choice("‚¨ÜÔ∏è –ü–æ–¥–Ω—è—Ç—å—Å—è –∫ –ë—É–Ω–∫–µ—Ä—É", "bunker_final_corridor")]
                }
            ),


            // =========================================================================
            // üõ°Ô∏è –í–ï–¢–ö–ê D: –í–•–û–î –í –ë–£–ù–ö–ï–† (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
            // =========================================================================
            "bunker_start_scenario": Step("bunker_start_scenario",
                "–í–•–û–î –í –ë–£–ù–ö–ï–†. –ó–¥–µ—Å—å —Å—É—Ö–æ –∏ —Ö–æ–ª–æ–¥–Ω–æ. –ì–µ—Ä–º–µ—Ç–∏—á–Ω–∞—è –¥–≤–µ—Ä—å –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –Ω–µ –∏–∑–¥–∞–µ—Ç –∑–≤—É–∫–æ–≤, –∫—Ä–æ–º–µ —Ç–∏—Ö–æ–≥–æ, –Ω–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –≥—É–ª–∞. –ù–∞–¥ –Ω–µ–π –º–∏–≥–∞–µ—Ç –∫—Ä–∞—Å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä. –í–∑–ª–æ–º–∞—Ç—å –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.",
                "start_scenario",
                {
                    choices: [Choice("–ù–∞—á–∞—Ç—å: –ö–æ–Ω—Å–æ–ª—å –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "bunker_task_1")]
                }
            ),

            "bunker_task_1": Step("bunker_task_1", "–ö–û–ù–°–û–õ–¨. –Ø ‚Äî —Ä–æ–≤–Ω–æ –∫–≤–∞–¥—Ä–∞—Ç —á–∏—Å–ª–∞ —Ç—Ä–∏. –í –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —è 100, –≤ –¥—Ä—É–≥–æ–π ‚Äî 1001. –ß—Ç–æ —è?",
                "logic_puzzle", { correctAnswer: "9", successNext: "bunker_task_2" }),

            "bunker_task_2": Step("bunker_task_2",
                "–°–ï–ù–°–û–†–´ –°–ö–ê–ù–ò–†–£–Æ–¢. –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ '–ß–ò–°–¢–ö–ê'. –í–µ—Ä–Ω–æ –ª–∏, —á—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å –ò–º–ø–ª–∞–Ω—Ç, —Å—á–∏—Ç–∞—é—Ç—Å—è '—á–∏—Å—Ç—ã–º–∏'?",
                "believe", { correctAnswerBool: true, successNext: "bunker_task_3" }),

            "bunker_task_3": Step("bunker_task_3",
                "–û–ö. –î–≤–µ—Ä—å –æ—Ç–∫—Ä—ã–ª–∞—Å—å, –Ω–æ —Å—Ä–∞–±–æ—Ç–∞–ª —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –º–∞—è–∫. –£ —Ç–µ–±—è –µ—Å—Ç—å —á–∏–ø—ã, —á—Ç–æ–±—ã –µ–≥–æ –æ—Ç–∫–ª—é—á–∏—Ç—å, –∏–ª–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –±–µ–∂–∞—Ç—å?",
                "decision_scenario",
                {
                    choices: [
                        Choice("üîá –û—Ç–∫–ª—é—á–∏—Ç—å –º–∞—è–∫ (-3 –ß–∏–ø–∞, +3 –ú–æ—Ä–∞–ª—å)", "bunker_final_corridor", 3, Effect(0, -3, 3, 0)),
                        Choice("üèÉ –ë–µ–∂–∞—Ç—å (-1 –ñ–∏–∑–Ω—å, -1 –ú–æ—Ä–∞–ª—å)", "bunker_final_corridor", 0, Effect(-1, 0, -1, 0))
                    ]
                }),
            
            // =========================================================================
            // üîë –§–ò–ù–ê–õ–¨–ù–´–ô –≠–¢–ê–ü
            // =========================================================================

            "bunker_final_corridor": Step("bunker_final_corridor",
                "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ö–û–†–ò–î–û–†. –¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –±–ª–∏–∑–æ—Å—Ç—å —Ü–µ–ª–∏. –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª. –í –≤–æ–∑–¥—É—Ö–µ –∑–∞–ø–∞—Ö –æ–∑–æ–Ω–∞ –∏ —Å–ª–∞–±—ã–π –≥—É–ª —ç–Ω–µ—Ä–≥–∏–∏.",
                "start_scenario",
                {
                    choices: [Choice("–ù–∞—á–∞—Ç—å: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞", "final_task_1")]
                }
            ),

            // –§–ò–ù–ê–õ–¨–ù–û–ï –°–¢–†–ï–°–°–û–í–û–ï –ó–ê–î–ê–ù–ò–ï
            "final_task_1": Step("final_task_1", "–°–ï–†–í–ï–† –ê–ö–¢–ò–í–ò–†–û–í–ê–ù. –í–≤–µ–¥–∏ –∫–æ–¥ –±—ã—Å—Ç—Ä–æ! '1, 1, 2, 3, 5, 8, [?], 21'",
                "speed_quiz", { correctAnswer: "13", successNext: "final_check_moral", failureNext: "final_failure", timeLimit: 10 }),

            "final_failure": Step("final_failure",
                "–ö–æ–¥ –≤–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ! –°—Ä–∞–±–æ—Ç–∞–ª–∞ –∞–≤–∞—Ä–∏–π–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –∑–∞–ø–µ—á–∞—Ç–∞–≤—à–∞—è –≤—ã—Ö–æ–¥. –¢—ã —Ç–µ—Ä—è–µ—à—å –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.",
                "decision_scenario",
                {
                    choices: [
                        Choice("–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ (-180 —Å–µ–∫)", "final_task_1", 0, Effect(0, 0, 0, -180))
                    ]
                }),

            // --- –û–ë–©–ò–ï –ù–ï–£–î–ê–ß–ò –∏ –ö–û–ù–¶–û–í–ö–ò ---
            "final_check_moral": Step("final_check_moral", "–§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê. –¢–≤–æ–π –º–æ—Ä–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ —Ä–µ—à–∏—Ç —Å—É–¥—å–±—É —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞. –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞...",
                "final_check_moral",
                {
                    choices: [Choice("üü¢ –û–¢–ü–†–ê–í–ò–¢–¨ –°–ò–ì–ù–ê–õ", "game_win")]
                }
            ),
            "game_win": Step("game_win", "–°–ò–ì–ù–ê–õ –£–°–ü–ï–®–ù–û –û–¢–ü–†–ê–í–õ–ï–ù! –¢—ã –≤—ã–∂–∏–ª –≤ –ù–µ–æ–Ω–æ–≤–æ–º –ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–µ! –ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è —Å–ø–∞—Å–µ–Ω–∏—è.", "final_win"),
            "game_over": Step("game_over", "–ñ–∏–∑–Ω–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –∏–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ. –¢–≤–æ–µ —Ç–µ–ª–æ –ø–æ–ø–æ–ª–Ω–∏–ª–æ –∞—Ä–º–∏—é –∑–æ–º–±–∏. –ö–û–ù–ï–¶ –ò–ì–†–´.", "final_lose"),
            "game_ending_bad": Step("game_ending_bad", "–°–ò–ì–ù–ê–õ –û–¢–ü–†–ê–í–õ–ï–ù... –ù–æ –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ –ú–æ—Ä–∞–ª—å–Ω–æ–≥–æ –†–µ–π—Ç–∏–Ω–≥–∞ (–º–µ–Ω—å—à–µ 5) —Ç—ã –≤—ã–∑–≤–∞–ª –Ω–µ —Å–ø–∞—Å–∞—Ç–µ–ª–µ–π, –∞ –ø–∞—Ç—Ä—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–±—Ä–∞–ª —Ç–µ–±—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–¥–æ–ø—ã—Ç–Ω–æ–≥–æ. –ö–û–ù–ï–¶ –ò–ì–†–´.", "final_lose"),
        };


        // --- 2. –ò–≥—Ä–æ–≤–æ–π –î–≤–∏–∂–æ–∫ ---

        class GameEngine {
            constructor() {
                this.state = {
                    currentStepKey: "start",
                    lives: 3,
                    bonuses: 0,
                    moralScore: 10,
                    timeLimit: INITIAL_TIME_LIMIT_SECONDS, 
                    currentTime: INITIAL_TIME_LIMIT_SECONDS,
                    startTime: Date.now() / 1000,
                    timer: null,
                    stepTimer: null, // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
                };
                this.dom = {
                    lives: document.getElementById('lives-display'),
                    chips: document.getElementById('chips-display'),
                    moral: document.getElementById('moral-display'),
                    time: document.getElementById('time-display'),
                    stepText: document.getElementById('step-text'),
                    stepKey: document.getElementById('step-key'),
                    choices: document.getElementById('choices-container'),
                    puzzleContainer: document.getElementById('puzzle-input-container'),
                    puzzleInput: document.getElementById('puzzle-input'),
                    puzzleButton: document.getElementById('puzzle-button'),
                    puzzleMessage: document.getElementById('puzzle-message'),
                    puzzleHint: document.getElementById('puzzle-hint'),
                    logArea: document.getElementById('log-area'),
                    finalScreen: document.getElementById('final-screen'),
                    finalTitle: document.getElementById('final-title'),
                    finalText: document.getElementById('final-text'),
                    finalStats: document.getElementById('final-stats'),
                };

                // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
                this.dom.puzzleButton.addEventListener('click', () => this.handlePuzzleInput());
                this.dom.puzzleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handlePuzzleInput();
                });
            }

            getCurrentStep() {
                return QUEST_STEPS[this.state.currentStepKey];
            }

            /** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–µ–∫—É–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç –ß–ß:–ú–ú:–°–° */
            formatTime(totalSeconds) {
                const s = Math.max(0, totalSeconds);
                const hours = Math.floor(s / 3600);
                const minutes = Math.floor((s % 3600) / 60);
                const seconds = Math.floor(s % 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            getElapsedTime() {
                return (Date.now() / 1000) - this.state.startTime;
            }

            updateTime() {
                const elapsedSeconds = this.getElapsedTime();
                this.state.currentTime = this.state.timeLimit - elapsedSeconds;
                this.dom.time.textContent = `‚è±Ô∏è –í—Ä–µ–º—è: ${this.formatTime(this.state.currentTime)}`;
            }
            
            /** –û–±–Ω–æ–≤–ª—è–µ—Ç "–≤–ø–∏—Å–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é" (–ª–æ–≥) */
            updateLog(message, isResult = false) {
                const logEntry = document.createElement('div');
                const timeStamp = this.formatTime(this.getElapsedTime());

                logEntry.className = `p-2 rounded-lg ${isResult ? 'bg-[#00ffc41a] text-neon' : 'bg-[#1e242d] text-gray-300'}`;
                logEntry.innerHTML = `<span class="font-bold mr-2 text-gray-500">${timeStamp}</span> ${message}`;
                
                this.dom.logArea.appendChild(logEntry);
                this.dom.logArea.scrollTop = this.dom.logArea.scrollHeight;
            }

            updateUI() {
                this.dom.lives.textContent = `‚ù§Ô∏è –ñ–∏–∑–Ω–∏: ${this.state.lives}`;
                this.dom.chips.textContent = `üåü –ß–∏–ø—ã: ${this.state.bonuses}`;
                this.dom.moral.textContent = `‚öñÔ∏è –ú–æ—Ä–∞–ª—å: ${this.state.moralScore}`;
            }

            checkGameOver() {
                if (this.state.lives <= 0 || this.state.currentTime <= 0) {
                    this.state.currentStepKey = "game_over";
                    this.renderFinalScreen();
                    return true;
                }
                return false;
            }
            
            applyEffect(effect) {
                this.state.lives = Math.max(0, this.state.lives + effect.lives);
                this.state.bonuses = Math.max(0, this.state.bonuses + effect.bonuses);
                this.state.moralScore += effect.moral;
                this.state.timeLimit += effect.time;
                this.updateUI();
                
                // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
                let logMessage = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: ";
                if (effect.lives !== 0) logMessage += `–ñ–∏–∑–Ω–∏: ${effect.lives > 0 ? '+' : ''}${effect.lives}, `;
                if (effect.bonuses !== 0) logMessage += `–ß–∏–ø—ã: ${effect.bonuses > 0 ? '+' : ''}${effect.bonuses}, `;
                if (effect.moral !== 0) logMessage += `–ú–æ—Ä–∞–ª—å: ${effect.moral > 0 ? '+' : ''}${effect.moral}, `;
                if (effect.time !== 0) {
                     const timeChange = this.formatTime(Math.abs(effect.time));
                     logMessage += `–í—Ä–µ–º—è: ${effect.time > 0 ? `+${timeChange}` : `-${timeChange}`}, `;
                }
                
                this.updateLog(logMessage.slice(0, -2), true);
                
                this.checkGameOver();
            }

            goToNextStep(nextStepKey) {
                if (this.checkGameOver()) return;
                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä —à–∞–≥–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
                if (this.state.stepTimer) {
                    clearTimeout(this.state.stepTimer);
                    this.state.stepTimer = null;
                }
                this.state.currentStepKey = nextStepKey;
                this.renderStep();
            }

            handleChoice(choiceIndex) {
                const current = this.getCurrentStep();
                if (!current.choices || choiceIndex < 0 || choiceIndex >= current.choices.length) return;

                const chosen = current.choices[choiceIndex];

                if (chosen.requiredBonus > 0 && this.state.bonuses < chosen.requiredBonus) {
                    this.dom.puzzleMessage.className = "mt-2 text-sm font-semibold text-red-400";
                    this.dom.puzzleMessage.textContent = `‚ùå –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ß–ò–ü–û–í! –¢—Ä–µ–±—É–µ—Ç—Å—è: ${chosen.requiredBonus}, —É –í–∞—Å: ${this.state.bonuses}`;
                    return;
                }
                
                this.updateLog(`–í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç: "${chosen.text}"`);

                if (chosen.effect) {
                    this.applyEffect(chosen.effect);
                }

                this.goToNextStep(chosen.next);
            }
            
            handlePuzzleInput() {
                const current = this.getCurrentStep();
                const input = this.dom.puzzleInput.value.trim();
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–≤–æ–¥–∞ (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã)
                const normalizedInput = input.toLowerCase().replace(/[^a-z–∞-—è0-9]/g, ''); 
                
                let isCorrect = false;
                let message = "";
                
                this.dom.puzzleMessage.textContent = "";

                switch (current.type) {
                    case "logic_puzzle":
                    case "speed_quiz":
                        const normalizedAnswer = current.correctAnswer.toLowerCase().replace(/[^a-z–∞-—è0-9]/g, '');
                        isCorrect = normalizedInput === normalizedAnswer;
                        break;
                    case "believe":
                        if (normalizedInput === "–≤–µ—Ä–Ω–æ" || normalizedInput === "–Ω–µ–≤–µ—Ä–Ω–æ") {
                            const inputBool = normalizedInput === "–≤–µ—Ä–Ω–æ";
                            isCorrect = inputBool === current.correctAnswerBool;
                        } else {
                            message = "‚ùå –û—à–∏–±–∫–∞! –í–≤–µ–¥–∏—Ç–µ '–≤–µ—Ä–Ω–æ' –∏–ª–∏ '–Ω–µ–≤–µ—Ä–Ω–æ'.";
                        }
                        break;
                }
                
                if (message) {
                    this.dom.puzzleMessage.className = "mt-2 text-sm font-semibold text-red-400";
                    this.dom.puzzleMessage.textContent = message;
                    return;
                }

                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä —à–∞–≥–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                if (this.state.stepTimer) {
                    clearTimeout(this.state.stepTimer);
                    this.state.stepTimer = null;
                }

                this.dom.puzzleInput.value = '';
                this.updateLog(`–í–≤–µ–¥–µ–Ω –æ—Ç–≤–µ—Ç: "${input}"`);

                if (isCorrect) {
                    this.applyEffect(Effect(0, 1, 0, 0)); // –£—Å–ø–µ—Ö: +1 –ß–∏–ø
                    message = "‚úÖ –£–°–ü–ï–•! (+1 –ß–∏–ø).";
                } else {
                    this.applyEffect(Effect(-1, 0, 0, 0)); // –ù–µ—É–¥–∞—á–∞: -1 –ñ–∏–∑–Ω—å
                    message = "‚ùå –û–®–ò–ë–ö–ê! (-1 –ñ–∏–∑–Ω—å).";
                }
                
                this.dom.puzzleMessage.className = `mt-2 text-sm font-semibold ${isCorrect ? 'text-neon' : 'text-red-400'}`;
                this.dom.puzzleMessage.textContent = message;
                
                setTimeout(() => {
                    this.goToNextStep(current.successNext);
                }, 1000);
            }

            handleFinalCheck() {
                // –ï—Å–ª–∏ –ú–æ—Ä–∞–ª—å –Ω–∏–∑–∫–∞, –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç –ø–ª–æ—Ö—É—é –∫–æ–Ω—Ü–æ–≤–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–æ—à–µ–ª –¥–æ —Ñ–∏–Ω–∞–ª–∞
                if (this.state.moralScore < 5) {
                    this.goToNextStep("game_ending_bad");
                } else {
                    this.goToNextStep("game_win");
                }
            }

            // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ü–µ–Ω—ã ---

            renderStep() {
                const current = this.getCurrentStep();
                if (!current) return;
                
                this.dom.stepKey.textContent = current.key.toUpperCase();
                this.dom.stepText.textContent = current.text;
                this.dom.choices.innerHTML = '';
                this.dom.puzzleContainer.classList.add('hidden');
                this.dom.puzzleMessage.textContent = '';
                
                this.updateLog(`–ù–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: ${current.key.toUpperCase()}`, false);

                // –°—Ü–µ–Ω–∞—Ä–∏–∏ –≤—ã–±–æ—Ä–∞ (start_scenario, decision_scenario)
                if (current.choices) {
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä —à–∞–≥–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    if (this.state.stepTimer) {
                        clearTimeout(this.state.stepTimer);
                        this.state.stepTimer = null;
                    }

                    current.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        const isAvailable = choice.requiredBonus <= this.state.bonuses;
                        const requiredText = choice.requiredBonus > 0 ? ` (–¢—Ä–µ–±—É–µ—Ç—Å—è: ${choice.requiredBonus} –ß–∏–ø–æ–≤)` : '';
                        
                        button.className = `w-full btn-primary py-3 px-4 rounded-lg text-left ${isAvailable ? '' : 'disabled'}`;
                        button.textContent = `${index + 1}. ${choice.text}${requiredText}`;
                        button.disabled = !isAvailable;
                        button.onclick = () => this.handleChoice(index);
                        
                        this.dom.choices.appendChild(button);
                    });
                } 
                // –ó–∞–¥–∞–Ω–∏—è —Å –≤–≤–æ–¥–æ–º
                else if (current.type.endsWith("puzzle") || current.type === "believe" || current.type === "speed_quiz") {
                    this.dom.puzzleContainer.classList.remove('hidden');
                    let hint = "";
                    this.dom.puzzleInput.value = '';

                    switch(current.type) {
                        case "believe": hint = "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –í–≤–µ–¥–∏—Ç–µ '–≤–µ—Ä–Ω–æ' –∏–ª–∏ '–Ω–µ–≤–µ—Ä–Ω–æ'"; break;
                        case "speed_quiz": 
                            hint = `‚ùó –í–†–ï–ú–Ø –û–ì–†–ê–ù–ò–ß–ï–ù–û: ${current.timeLimit} —Å–µ–∫. (${this.formatTime(current.timeLimit)} —à—Ç—Ä–∞—Ñ –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ)`;
                            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞ —à–∞–≥–∞
                            this.state.stepTimer = setTimeout(() => {
                                this.updateLog(`–í—Ä–µ–º—è –Ω–∞ –æ—Ç–≤–µ—Ç –≤—ã—à–ª–æ! (-60 —Å–µ–∫ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ ${current.failureNext})`, true);
                                this.applyEffect(Effect(0, 0, 0, -60)); // –®—Ç—Ä–∞—Ñ –∑–∞ –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                                this.goToNextStep(current.failureNext);
                            }, current.timeLimit * 1000);
                            break;
                        default: hint = "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç (–æ–¥–Ω–æ —Å–ª–æ–≤–æ –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ).";
                    }
                    this.dom.puzzleHint.textContent = hint;
                    this.dom.puzzleInput.focus();
                }
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                else if (current.type === "final_check_moral") {
                    this.handleFinalCheck();
                }
            }
            
            renderFinalScreen() {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
                if (this.state.timer) clearInterval(this.state.timer);
                if (this.state.stepTimer) clearTimeout(this.state.stepTimer);
                
                this.dom.finalScreen.classList.remove('hidden');
                
                const current = this.getCurrentStep();
                const isWin = current.type === "final_win";

                this.dom.finalTitle.textContent = isWin ? "–ü–û–ë–ï–î–ê: –°–ò–ì–ù–ê–õ –û–¢–ü–†–ê–í–õ–ï–ù" : "–ü–û–†–ê–ñ–ï–ù–ò–ï: –ö–û–ù–ï–¶ –ò–ì–†–´";
                this.dom.finalTitle.className = `text-5xl font-extrabold mb-4 ${isWin ? 'text-neon' : 'text-red-500'}`;

                let finalTimeDisplay = this.formatTime(this.getElapsedTime());

                this.dom.finalText.textContent = current.text;
                this.dom.finalStats.innerHTML = `
                    ‚è±Ô∏è –í—Ä–µ–º—è –≤ –ø—É—Ç–∏: <span class="text-neon">${finalTimeDisplay}</span><br>
                    ‚ù§Ô∏è –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∂–∏–∑–Ω–∏: <span class="text-red-400">${this.state.lives}</span><br>
                    ‚öñÔ∏è –ú–æ—Ä–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥: <span class="text-indigo-400">${this.state.moralScore}</span>
                `;
            }

            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

            start() {
                this.updateUI();
                this.renderStep();
                // –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
                this.state.timer = setInterval(() => {
                    this.updateTime();
                    if (this.checkGameOver()) {
                        clearInterval(this.state.timer);
                    }
                }, 1000);
            }
        }

        // --- 3. –¢–æ—á–∫–∞ –í—Ö–æ–¥–∞ ---
        
        document.addEventListener('DOMContentLoaded', () => {
            const game = new GameEngine();
            game.start();
        });

    </script>
</body>
</html>
